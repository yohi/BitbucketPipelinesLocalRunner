# 要件定義書

## 概要

Bitbucket Pipelinesをローカル環境で実行できるツールを開発します。これにより、開発者はパイプラインの設定をローカルでテストし、デバッグできるようになります。本ツールは、`bitbucket-pipelines.yml`ファイルを解析し、Dockerコンテナを使用してパイプラインステップを実行します。

## 要件

### 要件 1

**ユーザーストーリー:** 開発者として、Bitbucket Pipelinesをローカルで実行したい。これにより、リポジトリにプッシュすることなく、パイプライン設定をテストおよびデバッグできるようになる。

#### 受け入れ基準

1. ローカルランナーコマンドを実行したとき、システムは現在のディレクトリの`bitbucket-pipelines.yml`ファイルを解析する
2. YAMLファイルが有効であるとき、システムはDockerコンテナを使用してパイプラインステップを実行する
3. ステップが失敗したとき、システムは実行を停止してエラーメッセージを表示する
4. すべてのステップが正常に完了したとき、システムは成功メッセージを表示する

### 要件 2

**ユーザーストーリー:** 開発者として、実行するパイプラインを指定したい。これにより、特定のブランチやカスタムパイプラインをローカルでテストできるようになる。

#### 受け入れ基準

1. ブランチ名を指定したとき、システムはそのブランチ用に定義されたパイプラインを実行する
2. カスタムパイプライン名を指定したとき、システムは指定されたカスタムパイプラインを実行する
3. パイプラインが指定されていない場合、システムはデフォルトパイプラインを実行する
4. 指定されたパイプラインが存在しないとき、システムはエラーメッセージを表示する

### 要件 3

**ユーザーストーリー:** 開発者として、ローカルパイプライン実行で環境変数を使用したい。これにより、異なる設定をテストできるようになる。

#### 受け入れ基準

1. `.env`ファイルで環境変数を定義したとき、システムは実行中にそれらを読み込んで使用する
2. コマンドライン経由で環境変数を渡したとき、システムは`.env`ファイルより高い優先度でそれらを使用する
3. Bitbucketシステム変数が参照されたとき、システムはモック値を提供するか、カスタム値を許可する
4. セキュア変数が参照されたとき、システムは値の入力を求めるか、ローカル設定を使用する

### 要件 4

**ユーザーストーリー:** 開発者として、詳細な実行ログを確認したい。これにより、パイプライン設定の問題をデバッグできるようになる。

#### 受け入れ基準

1. ステップが実行中のとき、システムはコンテナからのリアルタイム出力を表示する
2. 詳細モードが有効のとき、システムは実行されるDockerコマンドを表示する
3. ステップが完了したとき、システムは実行時間と終了コードを表示する
4. エラーが発生したとき、システムはコンテナログを含む詳細なエラー情報を表示する

### 要件 5

**ユーザーストーリー:** 開発者として、ローカルでキャッシュを使用したい。これにより、キャッシュ動作をテストし、ローカル実行速度を向上させることができる。

#### 受け入れ基準

1. ステップがキャッシュを定義したとき、システムはローカルキャッシュディレクトリを作成・維持する
2. キャッシュが再利用されるとき、システムは前回の実行からファイルを復元する
3. キャッシュディレクトリが存在しないとき、システムは自動的にそれらを作成する
4. キャッシュをクリアしたとき、システムはすべてのキャッシュデータを削除する

### 要件 6

**ユーザーストーリー:** 開発者として、サービス（データベースなど）をローカルで実行したい。これにより、統合シナリオをテストできるようになる。

#### 受け入れ基準

1. ステップがサービスを定義したとき、システムは必要なDockerコンテナを開始する
2. サービスが実行中のとき、システムはメインステップコンテナからアクセス可能にする
3. ステップが完了したとき、システムはサービスコンテナを停止・削除する
4. サービス起動が失敗したとき、システムはエラー情報を表示して実行を停止する

### 要件 7

**ユーザーストーリー:** 開発者として、アーティファクトをローカルで処理したい。これにより、ステップ間でのアーティファクト受け渡しをテストできるようになる。

#### 受け入れ基準

1. ステップがアーティファクトを生成したとき、システムはローカルアーティファクトディレクトリに保存する
2. 後続のステップが実行されるとき、システムは前のアーティファクトを利用可能にする
3. アーティファクトがパターンで指定されたとき、システムはglobパターンを使用してファイルをマッチする
4. アーティファクトが生成されないとき、システムはエラーなく続行する

### 要件 8

**ユーザーストーリー:** 開発者として、並列ステップをシミュレートしたい。これにより、並列実行動作をローカルでテストできるようになる。

#### 受け入れ基準

1. 並列ステップが定義されたとき、システムは別々のコンテナを使用して同時実行する
2. fail-fastが有効のとき、システムは1つが失敗したらすべての並列ステップを停止する
3. fail-fastが無効のとき、システムは1つが失敗しても他のステップを継続する
4. 並列ステップが完了したとき、システムは続行前にすべてを待機する

### 要件 9

**ユーザーストーリー:** 開発者として、ローカルランナーを設定したい。これにより、開発環境に合わせて動作をカスタマイズできるようになる。

#### 受け入れ基準

1. 設定ファイルを作成したとき、システムはデフォルト設定を上書きするためにそれを使用する
2. Dockerレジストリ認証情報を指定したとき、システムはプライベートイメージに対してそれらを使用する
3. リソース制限を設定したとき、システムはコンテナにそれらを適用する
4. ログレベルを設定したとき、システムは出力の詳細度を調整する